"use strict";const _e=require("querystring"),we=require("crypto"),pe=require("events"),I=i=>i&&typeof i=="object"&&"default"in i?i:{default:i},ke=I(_e),Te=I(we),ye=I(pe);var T=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},me={},ee={},D={},Q={},L={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.convertString=i.addConditionals=i.convertExtendedMeta=i.convertBasicMetaTag=i.joinArray=i.convertGetRecentTracks=i.setDate=i.convertEntryArray=i.convertEntry=i.convertImageArray=i.convertImage=i.convertSearchWithQuery=i.convertSearch=i.convertMeta=i.toArray=i.toBool=i.boolToInt=i.toInt=void 0;function e(s){if(typeof s=="number")return s;const f=parseInt(s,10);return isNaN(f)?null:f}i.toInt=e;const t=s=>Number(s);i.boolToInt=t;const r=s=>s!==0&&s&&s!=="0";i.toBool=r;function a(s){return s instanceof Array?s:s?[s]:[]}i.toArray=a;function n(s){for(let f of["page","perPage","total","totalPages","from","to","index","accepted","ignored"])s.hasOwnProperty(f)&&(s[f]=e(s[f]));for(let f of["artistcorrected","trackcorrected"])s.hasOwnProperty(f)&&(s[f]=(0,i.toBool)(s[f]));return s}i.convertMeta=n;function l(s){var f;return s.meta||(s.meta={}),delete s["opensearch:Query"]["#text"],s.meta.itemsPerPage=e(s["opensearch:itemsPerPage"]),delete s["opensearch:itemsPerPage"],s.meta.startIndex=e(s["opensearch:startIndex"]),delete s["opensearch:startIndex"],s.meta.totalResults=e(s["opensearch:totalResults"]),delete s["opensearch:totalResults"],s.meta.query={...s.meta.query,...s["opensearch:Query"]},delete s["opensearch:Query"],!((f=s.meta.query)===null||f===void 0)&&f.startPage&&(s.meta.query.startPage=e(s.meta.query.startPage)),s}i.convertSearch=l;function u(s){return s.meta,s.meta=s["@attr"],delete s["@attr"],s.meta.query={for:s.meta.for},delete s.meta.for,l(s)}i.convertSearchWithQuery=u;function d(s){return s.url=s["#text"],delete s["#text"],s}i.convertImage=d;const v=s=>a(s).map(d);i.convertImageArray=v;function h(s){var f;for(let R of["playcount","listeners","tagcount","userplaycount","rank","duration","taggings","reach","bootstrap","age","count","match"]){if(s.hasOwnProperty(R)){s[R]=e(s[R]);continue}!((f=s["@attr"])===null||f===void 0)&&f.hasOwnProperty(R)&&(s[R]=e(s["@attr"][R]),delete s["@attr"])}return s}function y(s){var f,R;return s.hasOwnProperty("streamable")&&(s.streamable.hasOwnProperty("fulltrack")?(s.streamable.isStreamable=(0,i.toBool)(s.streamable["#text"]),delete s.streamable["#text"],s.streamable.fulltrack=(0,i.toBool)(s.streamable.fulltrack)):s.streamable=(0,i.toBool)((R=(f=s.streamable)===null||f===void 0?void 0:f["#text"])!==null&&R!==void 0?R:s.streamable)),s}function b(s){s=h(s);for(let f of["ontour","userloved","subscriber","loved"])s.hasOwnProperty(f)&&(s[f]=(0,i.toBool)(s[f]));return s=y(s),s.hasOwnProperty("image")&&(s.image=(0,i.convertImageArray)(s.image)),s}i.convertEntry=b;const w=s=>a(s).map(b);i.convertEntryArray=w;function m(s){var f;return s.artist.hasOwnProperty("name")||(s.artist.name=s.artist["#text"],delete s.artist["#text"]),s.hasOwnProperty("album")&&((f=s.album).name||(f.name=s.album["#text"]),delete s.album["#text"]),s}function S(s,f){var R;return s.hasOwnProperty(f)&&(s[f].datetime=s[f]["#text"],delete s[f]["#text"],s[f].uts=e((R=s[f].uts)!==null&&R!==void 0?R:s[f].unixtime),delete s[f].unixtime),s}i.setDate=S;function g(s){var f;return s=m(s),s=S(s,"date"),!((f=s==null?void 0:s["@attr"])===null||f===void 0)&&f.hasOwnProperty("nowplaying")?(s.nowplaying=(0,i.toBool)(s["@attr"].nowplaying),delete s["@attr"]):s.nowplaying=!1,b(s)}const M=s=>a(s).map(g);i.convertGetRecentTracks=M;const C=s=>Array.isArray(s)?s.join(","):s;i.joinArray=C;function P(s){return s.meta=s["@attr"],delete s["@attr"],s.tags=a(s.tag),delete s.tag,s}i.convertBasicMetaTag=P;function N(s,f){return s.meta=n(s["@attr"]),delete s["@attr"],s[`${f}s`]=(0,i.convertEntryArray)(s[f]),delete s[f],s}i.convertExtendedMeta=N;function B(s,f){for(let[R,U]of Object.entries(f))U!==void 0&&(s[R]=U);return s}i.addConditionals=B;function V(s,f,R){if(typeof s!="string")return s;let U={};return U[f]=s,B(U,R)}i.convertString=V})(L);var K={exports:{}};(function(i,e){var t=typeof self<"u"?self:T,r=function(){function n(){this.fetch=!1,this.DOMException=t.DOMException}return n.prototype=t,new n}();(function(n){(function(l){var u={searchParams:"URLSearchParams"in n,iterable:"Symbol"in n&&"iterator"in Symbol,blob:"FileReader"in n&&"Blob"in n&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in n,arrayBuffer:"ArrayBuffer"in n};function d(o){return o&&DataView.prototype.isPrototypeOf(o)}if(u.arrayBuffer)var v=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],h=ArrayBuffer.isView||function(o){return o&&v.indexOf(Object.prototype.toString.call(o))>-1};function y(o){if(typeof o!="string"&&(o=String(o)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(o))throw new TypeError("Invalid character in header field name");return o.toLowerCase()}function b(o){return typeof o!="string"&&(o=String(o)),o}function w(o){var c={next:function(){var _=o.shift();return{done:_===void 0,value:_}}};return u.iterable&&(c[Symbol.iterator]=function(){return c}),c}function m(o){this.map={},o instanceof m?o.forEach(function(c,_){this.append(_,c)},this):Array.isArray(o)?o.forEach(function(c){this.append(c[0],c[1])},this):o&&Object.getOwnPropertyNames(o).forEach(function(c){this.append(c,o[c])},this)}m.prototype.append=function(o,c){o=y(o),c=b(c);var _=this.map[o];this.map[o]=_?_+", "+c:c},m.prototype.delete=function(o){delete this.map[y(o)]},m.prototype.get=function(o){return o=y(o),this.has(o)?this.map[o]:null},m.prototype.has=function(o){return this.map.hasOwnProperty(y(o))},m.prototype.set=function(o,c){this.map[y(o)]=b(c)},m.prototype.forEach=function(o,c){for(var _ in this.map)this.map.hasOwnProperty(_)&&o.call(c,this.map[_],_,this)},m.prototype.keys=function(){var o=[];return this.forEach(function(c,_){o.push(_)}),w(o)},m.prototype.values=function(){var o=[];return this.forEach(function(c){o.push(c)}),w(o)},m.prototype.entries=function(){var o=[];return this.forEach(function(c,_){o.push([_,c])}),w(o)},u.iterable&&(m.prototype[Symbol.iterator]=m.prototype.entries);function S(o){if(o.bodyUsed)return Promise.reject(new TypeError("Already read"));o.bodyUsed=!0}function g(o){return new Promise(function(c,_){o.onload=function(){c(o.result)},o.onerror=function(){_(o.error)}})}function M(o){var c=new FileReader,_=g(c);return c.readAsArrayBuffer(o),_}function C(o){var c=new FileReader,_=g(c);return c.readAsText(o),_}function P(o){for(var c=new Uint8Array(o),_=new Array(c.length),q=0;q<c.length;q++)_[q]=String.fromCharCode(c[q]);return _.join("")}function N(o){if(o.slice)return o.slice(0);var c=new Uint8Array(o.byteLength);return c.set(new Uint8Array(o)),c.buffer}function B(){return this.bodyUsed=!1,this._initBody=function(o){this._bodyInit=o,o?typeof o=="string"?this._bodyText=o:u.blob&&Blob.prototype.isPrototypeOf(o)?this._bodyBlob=o:u.formData&&FormData.prototype.isPrototypeOf(o)?this._bodyFormData=o:u.searchParams&&URLSearchParams.prototype.isPrototypeOf(o)?this._bodyText=o.toString():u.arrayBuffer&&u.blob&&d(o)?(this._bodyArrayBuffer=N(o.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):u.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(o)||h(o))?this._bodyArrayBuffer=N(o):this._bodyText=o=Object.prototype.toString.call(o):this._bodyText="",this.headers.get("content-type")||(typeof o=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):u.searchParams&&URLSearchParams.prototype.isPrototypeOf(o)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},u.blob&&(this.blob=function(){var o=S(this);if(o)return o;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?S(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(M)}),this.text=function(){var o=S(this);if(o)return o;if(this._bodyBlob)return C(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(P(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},u.formData&&(this.formData=function(){return this.text().then(R)}),this.json=function(){return this.text().then(JSON.parse)},this}var V=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function s(o){var c=o.toUpperCase();return V.indexOf(c)>-1?c:o}function f(o,c){c=c||{};var _=c.body;if(o instanceof f){if(o.bodyUsed)throw new TypeError("Already read");this.url=o.url,this.credentials=o.credentials,c.headers||(this.headers=new m(o.headers)),this.method=o.method,this.mode=o.mode,this.signal=o.signal,!_&&o._bodyInit!=null&&(_=o._bodyInit,o.bodyUsed=!0)}else this.url=String(o);if(this.credentials=c.credentials||this.credentials||"same-origin",(c.headers||!this.headers)&&(this.headers=new m(c.headers)),this.method=s(c.method||this.method||"GET"),this.mode=c.mode||this.mode||null,this.signal=c.signal||this.signal,this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&_)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(_)}f.prototype.clone=function(){return new f(this,{body:this._bodyInit})};function R(o){var c=new FormData;return o.trim().split("&").forEach(function(_){if(_){var q=_.split("="),E=q.shift().replace(/\+/g," "),A=q.join("=").replace(/\+/g," ");c.append(decodeURIComponent(E),decodeURIComponent(A))}}),c}function U(o){var c=new m,_=o.replace(/\r?\n[\t ]+/g," ");return _.split(/\r?\n/).forEach(function(q){var E=q.split(":"),A=E.shift().trim();if(A){var H=E.join(":").trim();c.append(A,H)}}),c}B.call(f.prototype);function $(o,c){c||(c={}),this.type="default",this.status=c.status===void 0?200:c.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in c?c.statusText:"OK",this.headers=new m(c.headers),this.url=c.url||"",this._initBody(o)}B.call($.prototype),$.prototype.clone=function(){return new $(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new m(this.headers),url:this.url})},$.error=function(){var o=new $(null,{status:0,statusText:""});return o.type="error",o};var be=[301,302,303,307,308];$.redirect=function(o,c){if(be.indexOf(c)===-1)throw new RangeError("Invalid status code");return new $(null,{status:c,headers:{location:o}})},l.DOMException=n.DOMException;try{new l.DOMException}catch{l.DOMException=function(c,_){this.message=c,this.name=_;var q=Error(c);this.stack=q.stack},l.DOMException.prototype=Object.create(Error.prototype),l.DOMException.prototype.constructor=l.DOMException}function X(o,c){return new Promise(function(_,q){var E=new f(o,c);if(E.signal&&E.signal.aborted)return q(new l.DOMException("Aborted","AbortError"));var A=new XMLHttpRequest;function H(){A.abort()}A.onload=function(){var G={status:A.status,statusText:A.statusText,headers:U(A.getAllResponseHeaders()||"")};G.url="responseURL"in A?A.responseURL:G.headers.get("X-Request-URL");var J="response"in A?A.response:A.responseText;_(new $(J,G))},A.onerror=function(){q(new TypeError("Network request failed"))},A.ontimeout=function(){q(new TypeError("Network request failed"))},A.onabort=function(){q(new l.DOMException("Aborted","AbortError"))},A.open(E.method,E.url,!0),E.credentials==="include"?A.withCredentials=!0:E.credentials==="omit"&&(A.withCredentials=!1),"responseType"in A&&u.blob&&(A.responseType="blob"),E.headers.forEach(function(G,J){A.setRequestHeader(J,G)}),E.signal&&(E.signal.addEventListener("abort",H),A.onreadystatechange=function(){A.readyState===4&&E.signal.removeEventListener("abort",H)}),A.send(typeof E._bodyInit>"u"?null:E._bodyInit)})}return X.polyfill=!0,n.fetch||(n.fetch=X,n.Headers=m,n.Request=f,n.Response=$),l.Headers=m,l.Request=f,l.Response=$,l.fetch=X,Object.defineProperty(l,"__esModule",{value:!0}),l})({})})(r),r.fetch.ponyfill=!0,delete r.fetch.polyfill;var a=r;e=a.fetch,e.default=a.fetch,e.fetch=a.fetch,e.Headers=a.Headers,e.Request=a.Request,e.Response=a.Response,i.exports=e})(K,K.exports);var Ae=T&&T.__createBinding||(Object.create?function(i,e,t,r){r===void 0&&(r=t),Object.defineProperty(i,r,{enumerable:!0,get:function(){return e[t]}})}:function(i,e,t,r){r===void 0&&(r=t),i[r]=e[t]}),Pe=T&&T.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),Me=T&&T.__importStar||function(i){if(i&&i.__esModule)return i;var e={};if(i!=null)for(var t in i)t!=="default"&&Object.prototype.hasOwnProperty.call(i,t)&&Ae(e,i,t);return Pe(e,i),e},Se=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(Q,"__esModule",{value:!0});Q.LFMRequest=void 0;const de=ke.default,Oe=Me(Te.default),he=L,fe=Se(K.exports);class Re{constructor(e,t,r,a){var n,l;this.key=e.key,this.params=Object.fromEntries(Object.entries(a).filter(u=>u[1]!==void 0&&u[1]!==null)),this.secret=e.secret,this.userAgent=t,this.connectionType=r?"https":"http",this.context=e.context,this.startTime=Date.now(),this.params.hasOwnProperty("autocorrect")&&(this.params.autocorrect=(0,he.boolToInt)((n=this.params.autocorrect)!==null&&n!==void 0?n:!0)),this.params.hasOwnProperty("recenttracks")&&(this.params.recenttracks=(0,he.boolToInt)((l=this.params.recenttracks)!==null&&l!==void 0?l:!0)),this.params.hasOwnProperty("usernameOrSessionKey")&&(this.params.user=this.params.usernameOrSessionKey,delete this.params.usernameOrSessionKey)}async execute(){const e=this.isPostRequest();if(this.context.logger.emitRequest(this.params,e?"POST":"GET"),e){if(this.secret==="")throw new SyntaxError("Please enter an api secret key to use post requests with session key.");this.startTime=Date.now(),this.response=await this.post()}else this.startTime=Date.now(),this.response=await this.get();return{res:await this.checkStatus(),time:Date.now()-this.startTime}}async checkStatus(){if(!this.response.ok){const e=await this.response.json();throw typeof e=="object"&&e!==null&&e.hasOwnProperty("error")&&e.hasOwnProperty("message")?{code:e.error,message:e.message}:{message:this.response.statusText,response:e}}try{this.response=await this.response.json()}catch{throw new Error("Returned invalid json! Most likely a Last.FM issue.")}if(this.response.hasOwnProperty("error"))throw{message:this.response.message,code:this.response.error};return this.response}async post(){this.params.hasOwnProperty("user")&&(this.params.sk=this.params.user,delete this.params.user),this.params.hasOwnProperty("username")&&(this.params.sk=this.params.username,delete this.params.username);const e=this.getSignature(),t={...this.params,api_key:this.key,format:"json",api_sig:e},r=(0,de.stringify)(t);return await(0,fe.default)(`${this.connectionType}://ws.audioscrobbler.com/2.0/`,{method:"POST",headers:{"Content-Length":Buffer.byteLength(r).toString(),"Content-Type":"application/x-www-form-urlencoded","User-Agent":this.userAgent},body:r})}async get(){const e={api_key:this.key,format:"json",...this.params};return await(0,fe.default)(`${this.connectionType}://ws.audioscrobbler.com/2.0?${(0,de.stringify)(e)}`,{method:"GET",headers:{"User-Agent":this.userAgent}})}getSignature(){const e={...this.params,api_key:this.key};let r=Object.keys(e).sort().map(a=>[a,e[a]]).reduce((a,n)=>`${a}${n[0]}${n[1]}`,"");return r=Oe.createHash("md5").update(r+this.secret).digest("hex"),r}isPostRequest(){var e,t;return((e=this.params.user)===null||e===void 0?void 0:e.length)===32||((t=this.params.username)===null||t===void 0?void 0:t.length)===32||this.params.hasOwnProperty("sk")||this.params.hasOwnProperty("token")||this.params.hasOwnProperty("password")}}Q.LFMRequest=Re;Object.defineProperty(D,"__esModule",{value:!0});const Ee=Q;class qe{constructor(e,t,r="",a="lastfm-typed-npm",n=!1){this.key=e,this.secret=r,this.userAgent=a,this.secureConnection=n,this.info=t.info}checkLimit(e,t){if(typeof e<"u"&&(e>t||e<1))throw{message:`Limit out of bounds (1-${t}), ${e} passed`,code:6}}checkScrobbleCount(e,t){if(typeof e>"u"||e>t||e<1)throw{message:`Scrobble count out of bounds (1-${t}), ${e} passed`,code:6}}convertNumRes(e){let t={num_res:50,offset:0};return t.num_res=(e==null?void 0:e.limit)||50,t.offset=(((e==null?void 0:e.page)||1)-1)*t.num_res,t}convertGetTags(e){return(e==null?void 0:e["#text"])===" "&&(e.tag=[],delete e["#text"]),e}async sendRequest(e){const t=await new Ee.LFMRequest(this.info,this.userAgent,this.secureConnection,e).execute();return this.info.context.logger.emitRequestComplete(e,t.time,t.res),t.res}}D.default=qe;var Ce=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ee,"__esModule",{value:!0});const xe=Ce(D),F=L;class Le extends xe.default{async getInfo(e,t){return e=(0,F.convertString)(e,"tag",t!=null?t:{}),(await this.sendRequest({method:"tag.getInfo",...e,...t})).tag}async getTopAlbums(e,t){e=(0,F.convertString)(e,"tag",t!=null?t:{});let r=(await this.getTop("tag.getTopAlbums",e,t)).albums;return(0,F.convertExtendedMeta)(r,"album")}async getTopArtists(e,t){e=(0,F.convertString)(e,"tag",t!=null?t:{});let r=(await this.getTop("tag.getTopArtists",e,t)).topartists;return(0,F.convertExtendedMeta)(r,"artist")}async getTopTags(e){const t=this.convertNumRes(e);let r=(await this.getTop("tag.getTopTags",{},t)).toptags;const a=(0,F.toInt)(r["@attr"].total);if(a===null)throw"Total is not a number";let n={total:a,page:t.offset/t.num_res+1,perPage:t.num_res,totalPages:Math.ceil(a)/t.num_res};return r.meta=n,delete r["@attr"],r.tags=(0,F.convertEntryArray)(r.tag),delete r.tag,r}async getTopTracks(e,t){e=(0,F.convertString)(e,"tag",t!=null?t:{});let r=(await this.getTop("tag.getTopTracks",e,t)).tracks;return(0,F.convertExtendedMeta)(r,"track")}async getTop(e,t,r){var a,n;return this.checkLimit(((a=r==null?void 0:r.limit)!==null&&a!==void 0?a:t==null?void 0:t.limit)||((n=r==null?void 0:r.num_res)!==null&&n!==void 0?n:t==null?void 0:t.num_res),1e3),await this.sendRequest({method:e,...t,...r})}}ee.default=Le;var te={},Be=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(te,"__esModule",{value:!0});const De=Be(D),Y=L;class je extends De.default{async getTopArtists(e){let t=(await this.getTop("chart.getTopArtists",e)).artists;return(0,Y.convertExtendedMeta)(t,"artist")}async getTopTags(e){let t=(await this.getTop("chart.getTopTags",e)).tags;return(0,Y.convertExtendedMeta)(t,"tag")}async getTopTracks(e){let t=(await this.getTop("chart.getTopTracks",e)).tracks;return(0,Y.convertExtendedMeta)(t,"track")}async getTop(e,t){return this.checkLimit(t==null?void 0:t.limit,1e3),await this.sendRequest({method:e,...t})}}te.default=je;var re={},$e=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(re,"__esModule",{value:!0});const Fe=$e(D),Z=L;class Ue extends Fe.default{async getToken(e){const t=await this.sendRequest({method:"auth.getToken"});if(typeof t.token>"u")throw Error("Something went wrong while getting the token. Probably because of Last.FM");return t.token}async getSession(e){e=(0,Z.convertString)(e,"token",{});const t=(await this.sendRequest({method:"auth.getSession",...e})).session;return t.subscriber=(0,Z.toBool)(t.subscriber),t}async getMobileSession(e,t,r){return e=(0,Z.convertString)(e,"username",{password:t,token:r}),(await this.sendRequest({method:"auth.getMobileSession",...e})).session}}re.default=Ue;var ae={},Ne=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ae,"__esModule",{value:!0});const Ge=Ne(D),x=L;class He extends Ge.default{async addTags(e,t,r,a){return e=(0,x.convertString)(e,"artist",{album:t,tags:r,sk:a}),e.tags=(0,x.joinArray)(e.tags),await this.sendRequest({method:"album.addTags",...e})}async getInfo(e,t){var r,a;let n=(await this.sendRequest({method:"album.getInfo",...e,...t})).album;return n=(0,x.convertEntry)(n),n.tracks=(0,x.convertEntryArray)((r=n.tracks)===null||r===void 0?void 0:r.track),n.tags=(0,x.convertEntryArray)((a=n.tags)===null||a===void 0?void 0:a.tag),n}async getTags(e,t,r){let a=(0,x.addConditionals)({...e,...r},{user:t}),n=this.convertGetTags((await this.sendRequest({method:"album.getTags",...a})).tags);return(0,x.convertBasicMetaTag)(n)}async getTopTags(e,t){let r=(await this.sendRequest({method:"album.getTopTags",...e,...t})).toptags;return(0,x.convertBasicMetaTag)(r)}async removeTag(e,t,r,a){return e=(0,x.convertString)(e,"artist",{album:t,tag:r,sk:a}),await this.sendRequest({method:"album.removeTag",...e})}async search(e,t){var r;this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e.limit,1e3),e=(0,x.convertString)(e,"album",{});let a=(await this.sendRequest({method:"album.search",...e,...t})).results;return a=(0,x.convertSearchWithQuery)(a),a.albumMatches=(0,x.convertEntryArray)(a.albummatches.album),delete a.albummatches,a}}ae.default=He;var ne={},We=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ne,"__esModule",{value:!0});const ze=We(D),O=L;class Qe extends ze.default{async addTags(e,t,r){return e=(0,O.convertString)(e,"artist",{tags:t,sk:r}),e.tags=(0,O.joinArray)(e.tags),await this.sendRequest({method:"artist.addTags",...e})}async getCorrection(e){var t,r;e=(0,O.convertString)(e,"artist",{});let a=((r=(t=await this.sendRequest({method:"artist.getCorrection",...e}))===null||t===void 0?void 0:t.corrections)===null||r===void 0?void 0:r.correction)||{};return Object.keys(a).length&&(a.index=(0,O.toInt)(a["@attr"].index),delete a["@attr"]),a}async getInfo(e,t){var r,a,n;let l=(await this.sendRequest({method:"artist.getInfo",...e,...t})).artist;return l.similarArtists=(0,O.toArray)((r=l.similar)===null||r===void 0?void 0:r.artist),delete l.similar,l.tags=(0,O.toArray)((a=l.tags)===null||a===void 0?void 0:a.tag),l.bio&&(l.bio.link=(n=l.bio.links)===null||n===void 0?void 0:n.link,delete l.bio.links),l=(0,O.convertEntry)(l),l.stats=(0,O.convertEntry)(l.stats),l}async getSimilar(e,t){var r;this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e.limit,1e3);let a=(await this.sendRequest({method:"artist.getSimilar",...e,...t})).similarartists;return a.meta=a["@attr"],delete a["@attr"],a.artists=(0,O.convertEntryArray)(a.artist),delete a.artist,a}async getTags(e,t,r){let a=(0,O.addConditionals)({...e,...r},{user:t}),n=this.convertGetTags((await this.sendRequest({method:"artist.getTags",...a})).tags);return(0,O.convertBasicMetaTag)(n)}async getTopAlbums(e,t){var r;this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e.limit,1e3);let a=(await this.sendRequest({method:"artist.getTopAlbums",...e,...t})).topalbums;return a.albums=(0,O.toArray)(a.album).filter(n=>n.name!=="(null)").map(O.convertEntry),delete a.album,a.meta=(0,O.convertMeta)(a["@attr"]),delete a["@attr"],a}async getTopTags(e,t){let r=(await this.sendRequest({method:"artist.getTopTags",...e,...t})).toptags;return(0,O.convertBasicMetaTag)(r)}async getTopTracks(e,t){var r;this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e.limit,1e3);let a=(await this.sendRequest({method:"artist.getTopTracks",...e,...t})).toptracks;return a.tracks=(0,O.convertEntryArray)(a.track),delete a.track,a.meta=(0,O.convertMeta)(a["@attr"]),delete a["@attr"],a}async removeTag(e,t,r){return e=(0,O.convertString)(e,"artist",{tag:t,sk:r}),e.tag=(0,O.joinArray)(e.tag),await this.sendRequest({method:"artist.removeTag",...e})}async search(e,t){var r;this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e==null?void 0:e.limit,1e3),typeof e=="string"&&(e={artist:e});let a=(await this.sendRequest({method:"artist.search",...e,...t})).results;return a=(0,O.convertSearchWithQuery)(a),a.artistMatches=(0,O.convertEntryArray)(a.artistmatches.artist),delete a.artistmatches,a}}ne.default=Qe;var se={},Ve=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(se,"__esModule",{value:!0});const Xe=Ve(D),ve=L;class Je extends Xe.default{async getArtists(e,t){var r;e=(0,ve.convertString)(e,"user",{}),this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e==null?void 0:e.limit,1e3);let a=(await this.sendRequest({method:"library.getArtists",...e,...t})).artists;return(0,ve.convertExtendedMeta)(a,"artist")}}se.default=Je;var ie={},Ye=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ie,"__esModule",{value:!0});const Ze=Ye(D),k=L;class Ke extends Ze.default{async addTags(e,t,r,a){return e=(0,k.convertString)(e,"artist",{track:t,tags:r,sk:a}),e.tags=(0,k.joinArray)(e.tags),await this.sendRequest({method:"track.addTags",...e})}async getCorrection(e,t){var r,a;e=(0,k.convertString)(e,"artist",{track:t});let n=((a=(r=await this.sendRequest({method:"track.getCorrection",...e}))===null||r===void 0?void 0:r.corrections)===null||a===void 0?void 0:a.correction)||{};return n.track.hasOwnProperty("name")||(n={}),Object.keys(n).length&&(n.meta=(0,k.convertMeta)(n["@attr"]),delete n["@attr"]),n}async getInfo(e,t){var r,a;let n=(await this.sendRequest({method:"track.getInfo",...e,...t})).track;return n.toptags=(0,k.toArray)((r=n.toptags)===null||r===void 0?void 0:r.tag),n=(0,k.convertEntry)(n),n.album&&(n.album["@attr"]&&(n.album.position=(0,k.toInt)((a=n.album["@attr"])===null||a===void 0?void 0:a.position),delete n.album["@attr"]),n.album.image=(0,k.convertImageArray)(n.album.image)),n}async getSimilar(e,t){var r;this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e==null?void 0:e.limit,1e3);let a=(await this.sendRequest({method:"track.getSimilar",...e,...t})).similartracks;return(0,k.convertExtendedMeta)(a,"track")}async getTags(e,t,r){e=(0,k.addConditionals)(e,{username:t});let a=this.convertGetTags((await this.sendRequest({method:"track.getTags",...e,...r})).tags);return(0,k.convertBasicMetaTag)(a)}async getTopTags(e,t){let r=(await this.sendRequest({method:"track.getTopTags",...e,...t})).toptags;return(0,k.convertBasicMetaTag)(r)}async love(e,t,r){return e=(0,k.convertString)(e,"artist",{track:t,sk:r}),await this.sendRequest({method:"track.love",...e})}async removeTag(e,t,r,a){return e=(0,k.convertString)(e,"artist",{track:t,sk:a,tag:r}),await this.sendRequest({method:"track.removeTag",...e})}async scrobble(e,t){e=(0,k.convertString)(e,"sk",{scrobbles:t}),this.checkScrobbleCount(e.scrobbles.length,50);let r={};for(let[n,l]of e.scrobbles.entries())for(let[u,d]of Object.entries(l))d!==void 0&&(u==="chosenByUser"?r[`${u}[${n}]`]=(0,k.boolToInt)(d):r[`${u}[${n}]`]=d);let a=(await this.sendRequest({method:"track.scrobble",...r,sk:e.sk})).scrobbles;return a.meta=(0,k.convertMeta)(a["@attr"]),delete a["@attr"],a.scrobbles=(0,k.toArray)(a.scrobble).map(n=>(n.ignoredMessage.message=n.ignoredMessage["#text"],delete n.ignoredMessage["#text"],n.artist["#text"]&&(n.artist.name=n.artist["#text"],delete n.artist["#text"]),n.album["#text"]&&(n.album.name=n.album["#text"],delete n.album["#text"]),n.track["#text"]&&(n.track.name=n.track["#text"],delete n.track["#text"]),n.albumArtist["#text"]&&(n.albumArtist.name=n.albumArtist["#text"],delete n.albumArtist["#text"]),n.artist.corrected=(0,k.toBool)(n.artist.corrected),n.album.corrected=(0,k.toBool)(n.album.corrected),n.albumArtist.corrected=(0,k.toBool)(n.albumArtist.corrected),n.track.corrected=(0,k.toBool)(n.track.corrected),n.ignoredMessage.code=(0,k.toInt)(n.ignoredMessage.code),n.timestamp=(0,k.toInt)(n.timestamp),n)),delete a.scrobble,a}async search(e,t){var r;e=(0,k.convertString)(e,"track",{}),this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e==null?void 0:e.limit,1e3);let a=(await this.sendRequest({method:"track.search",...e,...t})).results;return a=(0,k.convertSearch)(a),a.trackMatches=(0,k.convertEntryArray)(a.trackmatches.track),delete a.trackmatches,a}async unlove(e,t,r){return e=(0,k.convertString)(e,"artist",{track:t,sk:r}),await this.sendRequest({method:"track.unlove",...e})}async updateNowPlaying(e,t,r,a){return e=(0,k.convertString)(e,"artist",{track:t,sk:r}),await this.sendRequest({method:"track.updateNowPlaying",...e,...a})}}ie.default=Ke;var oe={},Ie=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(oe,"__esModule",{value:!0});const et=Ie(D),p=L;class tt extends et.default{async getFriends(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getFriends",...e,...t})).friends;return r.users=(0,p.toArray)(r.user).map(a=>(a=(0,p.setDate)(a,"registered"),a=(0,p.convertEntry)(a),a)),delete r.user,r.meta=(0,p.convertMeta)(r["@attr"]),delete r["@attr"],r}async getInfo(e,t){e=(0,p.convertString)(e,"user",{});let r=(await this.sendRequest({method:"user.getInfo",...e,...t})).user;return r.registered=(0,p.toInt)(r.registered.unixtime),r=(0,p.convertEntry)(r),r}async getLovedTracks(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getLovedTracks",...e,...t})).lovedtracks;return r.meta=(0,p.convertMeta)(r["@attr"]),delete r["@attr"],r.tracks=(0,p.toArray)(r.track).map(a=>(a=(0,p.setDate)(a,"date"),a=(0,p.convertEntry)(a),a)),delete r.track,r}async getPersonalTags(e,t,r,a){var n;this.checkLimit((n=a==null?void 0:a.limit)!==null&&n!==void 0?n:e==null?void 0:e.limit,1e3),e=(0,p.convertString)(e,"user",{tag:t,taggingType:r});let l=(await this.sendRequest({method:"user.getPersonalTags",...e,...a})).taggings;return l.hasOwnProperty("artists")?l.artists=(0,p.convertEntryArray)(l.artists.artist):l.hasOwnProperty("albums")?l.albums=(0,p.convertEntryArray)(l.albums.album):l.hasOwnProperty("tracks")&&(l.tracks=(0,p.convertEntryArray)(l.tracks.track)),l.meta=(0,p.convertMeta)(l["@attr"]),delete l["@attr"],l}async getRecentTracks(e,t){var r;e=this.checkLimitAndConvertString(e,t),t!=null&&t.hasOwnProperty("extended")?t.extended=(r=(0,p.toInt)(t.extended))!==null&&r!==void 0?r:0:e!=null&&e.hasOwnProperty("extended")&&(e.extended=(0,p.toInt)(e.extended));let a=(await this.sendRequest({method:"user.getRecentTracks",...e,...t})).recenttracks;return a.meta=(0,p.convertMeta)(a["@attr"]),delete a["@attr"],a.tracks=(0,p.convertGetRecentTracks)(a.track),delete a.track,a}async getTopAlbums(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getTopAlbums",...e,...t})).topalbums;return(0,p.convertExtendedMeta)(r,"album")}async getTopArtists(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getTopArtists",...e,...t})).topartists;return(0,p.convertExtendedMeta)(r,"artist")}async getTopTags(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getTopTags",...e,...t})).toptags;return(0,p.convertExtendedMeta)(r,"tag")}async getTopTracks(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getTopTracks",...e,...t})).toptracks;return(0,p.convertExtendedMeta)(r,"track")}async getWeeklyAlbumChart(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getWeeklyAlbumChart",...e,...t})).weeklyalbumchart;return r.meta=(0,p.convertMeta)(r["@attr"]),delete r["@attr"],r.albums=(0,p.toArray)(r.album).map(a=>(a.artist.name=a.artist["#text"],delete a.artist["#text"],a=(0,p.convertEntry)(a),a)),delete r.album,r}async getWeeklyArtistChart(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getWeeklyArtistChart",...e,...t})).weeklyartistchart;return(0,p.convertExtendedMeta)(r,"artist")}async getWeeklyChartList(e){let t=(await this.sendRequest({method:"user.getWeeklyChartList"})).weeklychartlist;return t.charts=(0,p.toArray)(t.chart).map(p.convertMeta),delete t.chart,t}async getWeeklyTrackChart(e,t){e=this.checkLimitAndConvertString(e,t);let r=(await this.sendRequest({method:"user.getWeeklyTrackChart",...e,...t})).weeklytrackchart;return r.meta=(0,p.convertMeta)(r["@attr"]),delete r["@attr"],r.tracks=(0,p.toArray)(r.track).map(a=>(a.artist.name=a.artist["#text"],delete a.artist["#text"],a=(0,p.convertEntry)(a),a)),delete r.track,r}checkLimitAndConvertString(e,t){var r;return this.checkLimit((r=t==null?void 0:t.limit)!==null&&r!==void 0?r:e==null?void 0:e.limit,1e3),(0,p.convertString)(e,"user",{})}}oe.default=tt;var le={};Object.defineProperty(le,"__esModule",{value:!0});const rt=ye.default,W=L;class at{constructor(e){this.ArtistFromMBID=t=>({mbid:t}),this.ArtistFromName=t=>({artist:t}),this.AlbumFromMBID=t=>({mbid:t}),this.AlbumFromName=(t,r)=>({artist:t,album:r}),this.TrackFromMBID=t=>({mbid:t}),this.TrackFromName=(t,r)=>({artist:t,track:r}),this.lastfm=e}async getCombo(e,t){var r;e=(0,W.convertString)(e,"user",{limit:Math.min(1e3,t!=null?t:200)});let a=[!0,!0,!0],n=[["",0],["",0],["",0]],l=0,u=!1,d=1e3,v=[];for(;e.limit>0&&a[0]===a[1]&&a[1]===a[2]&&a[2]===!0;){e.limit<1e3&&l>0?(d=e.limit,t=1e3):l===0&&e.limit<=1e3&&(d=e.limit),l++;let h=await this.lastfm.user.getRecentTracks({...e,page:l});l===1&&(n[0][0]=h.tracks[0].artist.name,n[1][0]=h.tracks[0].album.name,n[2][0]=h.tracks[0].name,v=h.tracks[0].image,n[1][0]===""&&(a[1]=!1)),!((r=h.tracks[0])===null||r===void 0)&&r.nowplaying&&(u=!0,h.tracks=h.tracks.slice(1));for(let y=0;y<d&&!(!a[0]&&!a[1]&&!a[2]);y++)a[0]&&(n[0][0]===h.tracks[Number(y)].artist.name?n[0][1]++:a[0]=!1),a[1]&&(n[1][0]===h.tracks[Number(y)].album.name?n[1][1]++:a[1]=!1),a[2]&&(n[2][0]===h.tracks[Number(y)].name?n[2][1]++:a[2]=!1)}return{artist:{name:n[0][0],combo:n[0][1]},album:{name:n[1][0],combo:n[1][1]},track:{name:n[2][0],combo:n[2][1]},nowplaying:u,image:v}}async getNowPlaying(e,t=[],r={extended:!0}){var a;e=(0,W.convertString)(e,"user",{detailTypes:t,...r}),e=this.homogenizeUserInput(e);const n=await this.lastfm.user.getRecentTracks(e.user,{limit:1,extended:e.extended}),l=n.tracks[0],u=l.artist.name,d=l.name,v=l.image,h=(a=l.album)===null||a===void 0?void 0:a.name,y=l.url,b=n.meta.user,w=l==null?void 0:l.nowplaying,m={recent:{data:n},artist:{successful:!1},album:{successful:!1},track:{successful:!1}};if(e.detailTypes){const S=await this.fetchDetails(e.user,e.detailTypes,u,h,d),g=S.map(C=>typeof C<"u"&&typeof C.error>"u");let M=0;return e.detailTypes.includes("artist")&&(m.artist.data=S[M],m.artist.successful=g[M],M++),e.detailTypes.includes("album")&&h&&(m.album.data=S[M],m.album.successful=g[M],M++),e.detailTypes.includes("track")&&(m.track.data=S[M],m.track.successful=g[M],M++),{recent:{artist:u,album:h,track:d,image:v,url:y,username:b,nowplaying:w},details:m}}return{recent:{artist:u,album:h,track:d,image:v,url:y,username:b,nowplaying:w},details:{recent:{data:n},artist:{successful:!1},album:{successful:!1},track:{successful:!1}}}}async getMatchingArtists(e,t,r,a){e=(0,W.convertString)(e,"user1",{user2:t,limit:r,period:a}),this.checkLimit(e.limit,1e3);let n=[this.lastfm.user.getTopArtists(e.user1,{limit:e.limit,period:e.period}),this.lastfm.user.getTopArtists(e.user2,{limit:e.limit,period:e.period})];const l=await Promise.all(n);return this.getIntersection(l[0].artists,l[1].artists)}cacheScrobbles(e,t){t!=null||(t={}),typeof e!="string"&&(t.previouslyCached=e.previouslyCached,t.parallelCaches=e.parallelCaches,t.rateLimitTimeout=e.rateLimitTimeout,e=e.user);let r=new rt.EventEmitter;return this.handleCaching(e,r,t),r}async handleCaching(e,t,r){let a;try{a=(await this.lastfm.user.getRecentTracks(e,{limit:1})).meta.total}catch{let b=setInterval(()=>{try{this.handleCaching(e,t,r),clearInterval(b)}catch{}});return}let n=a-((r==null?void 0:r.previouslyCached)||0),l=Math.ceil(n/1e3),u=!1,d=(r==null?void 0:r.rateLimitTimeout)||3e5;t.emit("start",{totalPages:l,count:n});let v=Array(l).fill("").map((b,w)=>w+1),h=Math.min((r==null?void 0:r.parallelCaches)||1,l),y=0;this.attemptClose(h,t);for(let b=1;b<=h;b++)v.shift(),this.handleCacheInstance(e,t,b,n);t.on("internalDontUse",b=>{if(typeof b!="number"){y++;let w=b;if(w.meta.page===l&&(w.tracks=w.tracks.slice(0,n%1e3)),t.emit("data",{data:w,completedPages:y,totalPages:l,progress:y/l}),v.length)if(!u)this.handleCacheInstance(e,t,v[0],n),v.shift();else{let m=setInterval(()=>{u||(this.handleCacheInstance(e,t,v[0],n),v.shift(),clearInterval(m))})}else h--,this.attemptClose(h,t)}else if(!u)this.handleCacheInstance(e,t,b,n);else{let w=setInterval(()=>{u||(this.handleCacheInstance(e,t,b,n),clearInterval(w))})}}),t.on("error",(b,w)=>{(0,W.toInt)(b.code)===29&&(u=!0,setTimeout(()=>{u=!1},d)),t.emit("internalDontUse",w)})}attemptClose(e,t){e===0&&(t.emit("close"),t.removeAllListeners())}async handleCacheInstance(e,t,r,a){var n;try{let l=await this.lastfm.user.getRecentTracks(e,{limit:1e3,page:r});l.tracks[0].nowplaying&&((n=l==null?void 0:l.tracks)===null||n===void 0||n.shift()),t.emit("internalDontUse",l)}catch(l){typeof l=="object"&&l!==null&&l.hasOwnProperty("code")&&l.hasOwnProperty("message")?t.emit("error",{code:Number(l.code),message:l.message},r):t.emit("error",{code:41,message:`An unknown error occurred. Details: ${l}`},r)}}getIntersection(e,t){const r=e.sort((d,v)=>d.name.localeCompare(v.name)),a=t.sort((d,v)=>d.name.localeCompare(v.name));let n=0,l=0,u=[];for(;n<r.length&&l<a.length;){const d=r[n].name.localeCompare(a[l].name);d===0?(u.push({name:r[n].name,url:r[n].url,playcount:[r[n].playcount,a[l].playcount]}),n++,l++):(n+=+(d<0),l+=+(d>0))}return u}checkLimit(e,t){if(typeof e<"u"&&(e>t||e<1))throw new Error(`Limit out of bounds (1-${t}), ${e} passed`)}async fetchDetails(e,t,r,a,n,l){let u=[],d={username:e};return l!=null&&l.sk&&(d.sk=l.sk),t!=null&&t.includes("artist")&&u.push(this.lastfm.artist.getInfo({artist:r},d).catch(v=>{})),(t==null?void 0:t.includes("album"))&&a&&u.push(this.lastfm.album.getInfo({artist:r,album:a},d).catch(v=>{})),t!=null&&t.includes("track")&&u.push(this.lastfm.track.getInfo({artist:r,track:n},d).catch(v=>{})),await Promise.all(u)}homogenizeUserInput(e){if(e.hasOwnProperty("user"))return e;for(let t of["username","sk","usernameOrSessionKey"])e.hasOwnProperty(t)&&(e.user=e[t],delete e[t]);throw"No valid user input"}}le.default=at;var ce={};Object.defineProperty(ce,"__esModule",{value:!0});class nt{constructor(e){this.lastfm=e}emitRequest(e,t){this.lastfm.emit("requestStart",e,t)}emitRequestComplete(e,t,r){this.lastfm.emit("requestComplete",e,t,r)}}ce.default=nt;var ue={},st=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ue,"__esModule",{value:!0});const it=st(D),z=L;class ot extends it.default{async getTopArtists(e,t){e=(0,z.convertString)(e,"country",{});let r=(await this.getTop("geo.getTopArtists",e,t)).topartists;return(0,z.convertExtendedMeta)(r,"artist")}async getTopTracks(e,t){e=(0,z.convertString)(e,"country",{});let r=(await this.getTop("geo.getTopTracks",e,t)).tracks;return(0,z.convertExtendedMeta)(r,"track")}async getTop(e,t,r){var a;return this.checkLimit((a=r==null?void 0:r.limit)!==null&&a!==void 0?a:t==null?void 0:t.limit,1e3),await this.sendRequest({method:e,...t,...r})}}ue.default=ot;var j=T&&T.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(me,"__esModule",{value:!0});const lt=j(ee),ct=j(te),ut=j(re),dt=j(ae),ht=j(ne),ft=j(se),vt=j(ie),yt=j(oe),mt=j(le),gt=j(ce),bt=ye.default,_t=j(ue);class wt extends bt.EventEmitter{constructor(e,t){var r,a,n;super(),t||(t={}),(r=t.apiSecret)!==null&&r!==void 0||(t.apiSecret=""),(a=t.userAgent)!==null&&a!==void 0||(t.userAgent="lastfm-typed-npm"),(n=t.secureConnection)!==null&&n!==void 0||(t.secureConnection=!0);let{apiSecret:l,userAgent:u,secureConnection:d}=t;this.info={key:e,secret:l,context:this},this.tag=new lt.default(e,this,l,u,d),this.chart=new ct.default(e,this,l,u,d),this.geo=new _t.default(e,this,l,u,d),this.auth=new ut.default(e,this,l,u,d),this.album=new dt.default(e,this,l,u,d),this.artist=new ht.default(e,this,l,u,d),this.library=new ft.default(e,this,l,u,d),this.track=new vt.default(e,this,l,u,d),this.user=new yt.default(e,this,l,u,d),this.helper=new mt.default(this),this.logger=new gt.default(this)}}var pt=me.default=wt,ge={exports:{}};(function(i){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(d,v,h){this.fn=d,this.context=v,this.once=h||!1}function n(d,v,h,y,b){if(typeof h!="function")throw new TypeError("The listener must be a function");var w=new a(h,y||d,b),m=t?t+v:v;return d._events[m]?d._events[m].fn?d._events[m]=[d._events[m],w]:d._events[m].push(w):(d._events[m]=w,d._eventsCount++),d}function l(d,v){--d._eventsCount===0?d._events=new r:delete d._events[v]}function u(){this._events=new r,this._eventsCount=0}u.prototype.eventNames=function(){var v=[],h,y;if(this._eventsCount===0)return v;for(y in h=this._events)e.call(h,y)&&v.push(t?y.slice(1):y);return Object.getOwnPropertySymbols?v.concat(Object.getOwnPropertySymbols(h)):v},u.prototype.listeners=function(v){var h=t?t+v:v,y=this._events[h];if(!y)return[];if(y.fn)return[y.fn];for(var b=0,w=y.length,m=new Array(w);b<w;b++)m[b]=y[b].fn;return m},u.prototype.listenerCount=function(v){var h=t?t+v:v,y=this._events[h];return y?y.fn?1:y.length:0},u.prototype.emit=function(v,h,y,b,w,m){var S=t?t+v:v;if(!this._events[S])return!1;var g=this._events[S],M=arguments.length,C,P;if(g.fn){switch(g.once&&this.removeListener(v,g.fn,void 0,!0),M){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,h),!0;case 3:return g.fn.call(g.context,h,y),!0;case 4:return g.fn.call(g.context,h,y,b),!0;case 5:return g.fn.call(g.context,h,y,b,w),!0;case 6:return g.fn.call(g.context,h,y,b,w,m),!0}for(P=1,C=new Array(M-1);P<M;P++)C[P-1]=arguments[P];g.fn.apply(g.context,C)}else{var N=g.length,B;for(P=0;P<N;P++)switch(g[P].once&&this.removeListener(v,g[P].fn,void 0,!0),M){case 1:g[P].fn.call(g[P].context);break;case 2:g[P].fn.call(g[P].context,h);break;case 3:g[P].fn.call(g[P].context,h,y);break;case 4:g[P].fn.call(g[P].context,h,y,b);break;default:if(!C)for(B=1,C=new Array(M-1);B<M;B++)C[B-1]=arguments[B];g[P].fn.apply(g[P].context,C)}}return!0},u.prototype.on=function(v,h,y){return n(this,v,h,y,!1)},u.prototype.once=function(v,h,y){return n(this,v,h,y,!0)},u.prototype.removeListener=function(v,h,y,b){var w=t?t+v:v;if(!this._events[w])return this;if(!h)return l(this,w),this;var m=this._events[w];if(m.fn)m.fn===h&&(!b||m.once)&&(!y||m.context===y)&&l(this,w);else{for(var S=0,g=[],M=m.length;S<M;S++)(m[S].fn!==h||b&&!m[S].once||y&&m[S].context!==y)&&g.push(m[S]);g.length?this._events[w]=g.length===1?g[0]:g:l(this,w)}return this},u.prototype.removeAllListeners=function(v){var h;return v?(h=t?t+v:v,this._events[h]&&l(this,h)):(this._events=new r,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=t,u.EventEmitter=u,i.exports=u})(ge);const kt=ge.exports,Tt=i=>new At(i);class At extends kt{constructor(e){super();let{api_key:t,user:r,poll_time:a,nowplaying_only:n,user_agent:l}=e;this.api_key=t,this.lastFm=new pt(t),this.user=r,this.poll_time=a||1e4,this.nowplaying_only=n||!1,this.user_agent=l||"BarryCarlyon/1.0.0 https://github.com/BarryCarlyon/LastFMNowPlaying",this.start()}tock(){this.lastFm.user.getRecentTracks({username:this.user,limit:1}).then(e=>{this.emit("always",e);try{var{tracks:t}=e,r=t[0],a=!1;if(r.nowplaying&&(a=!0),!a&&this.nowplaying_only){this.emit("nochange");return}var n=r.name;this.lasttrack!=n?(this.lasttrack=n,this.emit("song",r)):this.emit("nochange")}catch(l){this.emit("error",l)}}).catch(e=>{this.emit("error",e)})}start(){this.stop(),this.tick=setInterval(()=>{this.tock()},this.poll_time),this.tock()}stop(){clearInterval(this.tick)}}module.exports=function(i){const e=i.log;e.info("current song bundle started.");const t=i.bundleConfig;var r=Tt({api_key:t.apikey,user:t.music.lastfmUser,user_agent:t.user_agent}),a=i.Replicant("currentSong",{defaultValue:{title:"Loading...",artist:"Overlay by devJimmyboy",albumArt:""},persistent:!0,persistenceInterval:500});i.Replicant("popoutTop",{defaultValue:"5%",persistent:!0}),r.on("error",function(n){console.error(n)}).on("song",n=>{e.debug(`Successfully received data from Last.fm:
`,n.name,"by",n.artist.name,"from",n.album.name,`
`,n.image[0].url);var l={artist:n.artist.name,title:n.name,albumArt:n.image.reduceRight((u,d)=>d.size>=u.size?d:u).url};a.value.title!==n.name&&a.value.artist!==n.artist.name&&(a.value=l)})};
//# sourceMappingURL=index.js.map
